#!/bin/sh -e

# Source debconf library.
. /usr/share/debconf/confmodule

# Decide how important it is for the user to see this message
PRIORITY=high


# postrm and config must check for the existance of this first
# to be compliant with policy 7.2
if [ -f /usr/share/dbconfig-common/dpkg/frontend.config ]; then
    # Hint more sensible defaults to dbconfig-common for dbname and dbuser
    dbc_dbuser=zaspanel-main
    dbc_dbname=zaspanel-main
    dbc_dbtypes="pgsql"
    dbc_authmethod_user="password"
    . /usr/share/dbconfig-common/dpkg/frontend.config
    dbc_go symfony2-site-zaspanel-main $@
fi

db_input $PRIORITY symfony2-site-zaspanel-main/webroot || true
db_go

db_input $PRIORITY symfony2-site-zaspanel-main/protocol || true
db_go

db_input $PRIORITY symfony2-site-zaspanel-main/primaryvirtualhost || true
db_go

db_get symfony2-site-zaspanel-main/protocol
if [ "${RET}" = 'mixed' ]; then
    db_input $PRIORITY symfony2-site-zaspanel-main/secondaryvirtualhost || true
    db_go
else
    db_reset symfony2-site-zaspanel-main/secondaryvirtualhost
fi

db_input $PRIORITY symfony2-site-zaspanel-main/primaryredirects || true
db_go

db_input $PRIORITY symfony2-site-zaspanel-main/primaryaliases || true
db_go

db_input $PRIORITY symfony2-site-zaspanel-main/siteenabled || true
db_go

db_input $PRIORITY symfony2-site-zaspanel-main/staging || true
db_go

db_get symfony2-site-zaspanel-main/staging
if [ "${RET}" = true ]; then
    safe=1
    if [ -f /etc/packaged-site/symfony2-site-zaspanel-main/htpassd ]; then
        db_input $PRIORITY symfony2-site-zaspanel-main/stage_file_exists || true
        db_go

        db_get symfony2-site-zaspanel-main/stage_file_exists
        if [ "${RET}" = false ]; then
            safe=0
        fi
    fi
    if [ $safe = 1 ]; then
        ok=''
        while [ ! "$ok" ]; do
            db_input $PRIORITY symfony2-site-zaspanel-main/stage_username || true
            db_go || true

            db_get symfony2-site-zaspanel-main/stage_username
            if [ "$RET" ]; then
                ok=1
            fi
        done

        ok=''
        while [ ! "$ok" ]; do
            db_input $PRIORITY symfony2-site-zaspanel-main/stage_password || true
            db_go || true

            db_get symfony2-site-zaspanel-main/stage_password
            if [ "$RET" ]; then
                ok=1
            fi
        done
    fi
else
    db_reset symfony2-site-zaspanel-main/stage_username
    db_reset symfony2-site-zaspanel-main/stage_password
fi
